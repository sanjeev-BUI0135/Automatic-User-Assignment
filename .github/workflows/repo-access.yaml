name: Repo Access Auto Control

on:
  schedule:
    - cron: "*/10 * * * *"   # Runs every 10 minutes
  workflow_dispatch:         # Allows manual run

jobs:
  manage-access:
    runs-on: ubuntu-latest

    steps:
      - name: Install GitHub CLI and jq
        run: |
          sudo apt update
          sudo apt install gh jq -y

      - name: Authenticate with GitHub
        run: echo "${{ secrets.ORG_TOKEN }}" | gh auth login --with-token

      - name: Manage Repository Access
        run: |
          ORG="sanjeev-BUI0135"
          NOW=$(date -u +%s)

          gh repo list $ORG --limit 200 --json name,createdAt,repositoryTopics | jq -c '.[]' | while read repo; do
            NAME=$(echo $repo | jq -r '.name')
            CREATED=$(echo $repo | jq -r '.createdAt')
            CREATED_TS=$(date -d "$CREATED" +%s)

            MINUTES=$(( (NOW - CREATED_TS) / 60 ))
            HOURS=$(( (NOW - CREATED_TS) / 3600 ))

            USER=""

            # Read repository topics safely
            for topic in $(echo $repo | jq -r '.repositoryTopics[]?.name // empty'); do
              if [ "$topic" = "assign-bui-job" ]; then
                USER="bui-job"
              elif [ "$topic" = "assign-interview1" ]; then
                USER="interview1"
              fi
            done

            # Skip if no assignment topic
            if [ -z "$USER" ]; then
              continue
            fi

            # Add access within first 10 minutes
            if [ $MINUTES -lt 10 ]; then
              echo "Adding $USER to $NAME"
              gh api -X PUT repos/$ORG/$NAME/collaborators/$USER -f permission=write
            fi

            # Remove access after 24 hours
            if [ $HOURS -ge 24 ]; then
              echo "Removing $USER from $NAME"
              gh api -X DELETE repos/$ORG/$NAME/collaborators/$USER || true
            fi
          done
